# PLAN.md - 重构与优化计划

## A. 现状评估

### A1. 已实现较完整
- 视频上传/导入、房间、播放同步、聊天、WebRTC、多集列表。
- 房间续播持久化与每集进度记录。
- 播放池 + LRU + OSS 回源。
- Range 流式播放、全屏、倍速同步、独立音量。
- 上传/导入任务化状态（含压缩与 OSS 阶段）。

### A2. 主要问题
- 需求没有统一文档，后续维护成本高。
- 部署步骤仍偏手工，缺一键脚本。
- 任务数据可能长期增长，缺运维清理入口。
- 部分参数硬编码，缺显式可配置项（如自动连播倒计时、漂移阈值）。

### A3. 优化目标
- 补全“需求 -> 计划 -> 实现”闭环文档。
- 提供一键部署脚本。
- 补运维可用性（任务查询/清理）。
- 减少硬编码，提升可配置性和可维护性。

## B. 目标架构（本轮）
- 文档层：`Require.md` + `PLAN.md` + README 对齐。
- 服务层：
  - 上传/导入异步任务继续沿用。
  - 增加任务列表与清理接口（Root）。
  - 可配置同步参数（漂移阈值、自动下一集倒计时）。
- 部署层：
  - 单脚本完成依赖安装、环境初始化、目录准备、进程启动。

## C. 实施步骤

### 阶段 1：文档固化（完成）
- [x] 产出 `Require.md`。
- [x] 产出 `PLAN.md`。

### 阶段 2：服务端优化（本轮完成）
- [x] 引入可配置同步参数：
  - `SYNC_DRIFT_SOFT_THRESHOLD_MS`
  - `SYNC_DRIFT_HARD_THRESHOLD_MS`
  - `AUTOPLAY_COUNTDOWN_SECONDS`
- [x] 增加 Root 任务运维接口：
  - `GET /api/admin/video-jobs`
  - `DELETE /api/admin/video-jobs`（按保留天数清理已完成/失败任务）

### 阶段 3：前端对齐（本轮完成）
- [x] 房间页读取同步参数并应用（避免硬编码）。
- [x] 连播倒计时默认值与后端配置一致。
- [x] 管理页提供任务查看与清理入口。

### 阶段 4：部署脚本（本轮完成）
- [x] 新增 `scripts/deploy.sh`：
  - 检查 Node/npm
  - `npm install --omit=dev`
  - `.env` 初始化
  - 创建数据目录
  - 优先 pm2 启动，否则 nohup 启动
  - 输出访问地址与日志路径

### 阶段 5：验证（本轮完成）
- [x] `node --check` 全量通过。
- [x] README 增补部署与运维接口说明。

## D. 非目标（本轮不做）
- 集群化多节点同步（Redis adapter / SFU）。
- TURN 自动部署。
- 云原生编排（K8s Helm）。

## E. 风险与缓解
- 风险：本地无 pm2 导致守护不可用。
- 缓解：脚本自动回退 `nohup` 并给出日志位置。

- 风险：转码耗时长。
- 缓解：保持异步任务化，不阻塞请求。

- 风险：任务表增长。
- 缓解：提供 Root 清理接口并在 README 说明。

## F. 交付物
- `Require.md`
- `PLAN.md`
- 服务端运维增强（任务列表/清理 + 配置参数）
- 前端管理增强（任务查看/清理）
- `scripts/deploy.sh`
- README 更新
