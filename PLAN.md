# PLAN.md

## 目标重构
围绕三条主线完成系统重构：
1. 上传入口统一为文件上传。
2. 房间支持双播放模式（`cloud` / `local_file`）且创建时必选。
3. 引入统一用户体系并替换旧 `creator_token` 权限模型。

## 实施方案

### 阶段 1：数据与鉴权基座
- 新增 `users` 表与用户读写接口。
- 注册/登录/登出/me 全套接口。
- 首个注册用户自动 root。
- 全站 API 统一鉴权；Root 路由做角色校验。

### 阶段 2：房间所有权与模式
- `rooms` 增加 `created_by_user_id`、`room_mode`。
- 创建房间时写入用户 ID 和模式。
- 删除房间改为“创建者或 Root”。
- legacy 房间无 owner 时仅 Root 可删。

### 阶段 3：上传链路收敛
- 删除远程导入 API 与前端入口。
- 保留上传异步任务流转与状态查询。
- 上传后仍执行压缩、入池、可选 OSS 后传。

### 阶段 4：local_file 门禁
- Socket 协议新增：
  - 服务端事件 `local-file-required`
  - 客户端事件 `local-file-verified`
  - 拒绝事件 `playback-denied`
- 服务端维护 `roomId + userId + episodeIndex` 校验态。
- 客户端对当前集计算 SHA-256 并上报通过状态。
- 未通过校验时锁定播放控制，仅保留聊天/语音。

### 阶段 5：前端登录态驱动
- 首页加入注册/登录，业务区按登录态展示。
- 房间页移除昵称输入，用户名来自登录用户。
- 管理页移除 root 专用登录，改为 `role === root` 门禁。

### 阶段 6：文档与部署
- 更新 `Require.md`、`PLAN.md`、`README.md`。
- 保留单脚本部署：`scripts/deploy.sh`。

## 验收清单
- [ ] 首个注册用户为 root，第二个为 user。
- [ ] 未登录访问业务 API 返回 401。
- [ ] 普通用户访问 Root API 返回 403。
- [ ] 房间创建不传 `roomMode` 返回 400。
- [ ] 删除远程导入后无 `import-remote` 入口。
- [ ] local_file 未校验当前集时播放被拒绝，校验后可同步。
- [ ] 切集后按新当前集重新校验。
- [ ] 房间进度（集数/时间/倍速）持久化不退化。
- [ ] 聊天、语音、漂移校正、连播倒计时可正常使用。
