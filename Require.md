# Require.md - 一起看服务完整需求规格

## 1. 目标
提供一个可在服务器部署的“多人一起看”服务，支持上传/导入视频、创建放映室、同步播放、语音视频聊天、消息聊天、房间进度持久化、本地播放池与 OSS 扩展存储。

## 2. 角色与权限
- 游客/普通用户
- 放映室创建者
- Root 管理员

权限规则：
- 所有人可查看所有视频、所有视频列表、所有放映室。
- 所有人可基于视频或视频列表创建放映室。
- 放映室仅允许“创建者或 Root”删除。
- Root 可查看并管理全量放映室与存储状态。

## 3. 视频来源与入库

### 3.1 来源
- 本地文件上传（网页上传）
- 服务器路径导入（server_path）
- 远程 URL 导入（remote_url）

### 3.2 Hash 与去重
- 支持传入可选 `expectedHash`（SHA-256, 64 hex）校验。
- 同 hash 视频应复用底层文件，避免重复存储。
- 本地与远程导入均要保证 hash 校验路径一致。

### 3.3 格式支持
- 后端需明确列出支持格式和 MIME。
- 当前支持扩展名：`.mp4 .webm .ogg .ogv .m4v .mov .mkv .avi .ts`
- 最终播放能力受浏览器解码能力影响。

### 3.4 统一压缩/转码
- 上传/导入后统一转码为标准播放格式：`MP4(H.264 + AAC)`。
- 需支持硬件编码参数与 CPU 回退。
- 若开启 OSS，入库后可后台上传到 OSS。

### 3.5 状态跟踪（必须可观察）
上传/导入全过程需可追踪：
- 上传中（浏览器 -> 服务端）
- hash 校验中
- 压缩/转码中
- 本地播放池入库中
- OSS 传输中（若启用）
- 完成 / 失败

## 4. 播放池与存储策略

### 4.1 本地播放池
- 视频默认存放在本地播放池。
- 播放池容量可配置。

### 4.2 LRU 淘汰
- 播放池满时按 LRU 淘汰。
- 正在播放/正在读取的视频不能淘汰（必须跳过）。
- 若没有可淘汰文件，返回明确告警信息。

### 4.3 OSS 扩展存储
- 管理员可配置阿里云 OSS。
- 上传后若配置了 OSS，应同步/异步入 OSS。
- 播放时若本地无文件，自动从 OSS 回源到本地播放池。
- 回源后需做 hash 校验，失败要报错。

### 4.4 空间可视化与限制
- 展示：播放池已用、上限、可用、文件数。
- 展示：所在磁盘总量与剩余空间（环境支持时）。
- 展示/执行：上传大小限制（MAX_UPLOAD_SIZE_BYTES）。

## 5. 视频组织与放映室

### 5.1 视频与唯一链接
- 每个视频有唯一详情链接。
- 所有人可查看该视频下的所有放映室。

### 5.2 视频列表（多集）
- 支持创建视频列表（按顺序多集）。
- 可基于视频列表创建放映室。
- 房间中同一时刻只播放一集，支持手动切集与自动连播。

### 5.3 放映室生命周期
- 放映室不因无人在线自动删除。
- 删除仅允许创建者或 Root。

## 6. 房间内同步与体验

### 6.1 基础同步
- 播放/暂停/拖拽/切集/倍速应同步全房间。
- 倍速与播放状态属于房间级状态。

### 6.2 新用户自动对齐（追帧/追音频策略）
- 新用户加入后应自动追到房间当前进度。
- 进入时应优先快速对齐，避免刚加入时明显不同步。

### 6.3 漂移校正
- 播放中周期检测 drift。
- 差值 > 200ms：优先采用轻微快放/慢放微调。
- 差值过大：执行小幅跳转（seek）强制对齐。

### 6.4 连播体验
- 自动下一集应采用倒计时（可取消）。
- 倒计时取消状态需可同步。

### 6.5 音频与显示控制
- 支持全屏。
- 独立调节视频音量与语音音量。
- 支持视频静音与语音静音。

### 6.6 缓冲支持
- 视频流接口支持 HTTP Range。
- 对非法 Range 返回 416。

## 7. 语音视频与聊天
- 房间支持 WebRTC 音视频。
- 房间支持文字消息聊天。
- 基础成员列表可见。

## 8. 进度与数据持久化

### 8.1 房间级续播
- 记录房间当前“第几集 + 当前时间 + 倍速 + 播放状态”。
- 任何用户后续进入都应续播到最新房间进度。

### 8.2 每集进度
- 记录每一集的 `last/max/watched` 进度。
- 房间内应可见每集进度摘要。

## 9. 管理能力
- Root 登录/登出。
- Root 查看所有放映室、删除任意放映室。
- Root 查看存储状态（池 + 磁盘 + OSS）。

## 10. 部署要求
- 提供一键部署脚本，尽量减少手工步骤。
- 默认可本机单机运行，建议支持 pm2 守护。

## 11. 非功能性要求
- 失败可观测：明确错误信息。
- 接口返回结构一致，便于前端轮询与状态展示。
- 代码可维护：配置可外置，核心流程可追踪。

## 12. 验收要点（简版）
- 上传视频后可看到处理状态流转并最终可播放。
- 创建多集放映室后可同步播放、同步倍速、同步切集。
- 新用户进入后 1~2 秒内可追到房间进度；播放中 drift 能自动纠偏。
- 自动下一集倒计时可取消，取消后全房间保持一致。
- 播放池满时触发 LRU，正在播放文件不被误删。
- 本地无文件但 OSS 有时能回源播放。
- Root 可查看并删除任意放映室，可查看存储与磁盘剩余。
