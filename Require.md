# Require.md

## 1. 产品目标
构建可部署在服务器端的“多人一起看”系统，支持视频上传、放映室创建、同步播放、语音视频与聊天，并提供统一用户体系与 Root 管理能力。

## 2. 核心业务模型

### 2.1 视频
- 仅保留一个入库入口：`文件上传`。
- 上传后统一进入异步处理任务链路（hash、压缩、入池、OSS 上传）。
- 每个视频有唯一详情页链接。
- 所有人可浏览全部视频与视频列表。

### 2.2 视频列表（多集）
- 支持把多个视频按顺序组合为列表。
- 支持基于视频列表创建放映室。
- 房间同一时间仅播放一集，支持手动切集和自动连播。

### 2.3 放映室
- 放映室绑定创建人 `userId`。
- 放映室不会因无人在线自动删除。
- 删除权限：仅创建人或 Root。
- 房间进度持久化：`当前集 + 当前时间 + 播放状态 + 倍速 + 每集进度 + 累计观看时长`。

## 3. 双播放模式
创建放映室必须显式选择 `roomMode`：
- `cloud`：云端托管播放，按正常媒体流同步。
- `local_file`：本地文件门禁播放。

### 3.1 local_file 门禁规则
- 服务端为当前集下发 `contentHash`（SHA-256）。
- 用户需在前端选择本地文件，计算 SHA-256，与当前集 hash 一致后才可解锁播放控制。
- 仅校验当前集；切集后需要对新当前集重新校验。
- 校验映射只保留在当前前端会话内（刷新后需重选）。
- 未通过当前集校验时：可聊天/语音，但播放控制被锁定；服务端拒绝其 `playback-update`。

## 4. 用户体系与权限

### 4.1 认证
- 提供注册/登录/登出/当前用户接口。
- 全站业务能力默认要求登录。
- 首个注册用户自动成为 `root`，后续用户为 `user`。

### 4.2 角色能力
- `user`：上传视频、创建房间、进入房间、删除自己创建的房间。
- `root`：拥有 user 全部能力，另可查看/管理全量房间、查看存储状态、管理任务。

## 5. 同步与播放体验
- 播放/暂停/拖拽/倍速/切集全房间同步。
- 新用户加入自动追帧到房间进度。
- 漂移校正：小漂移微调速度，大漂移小跳转对齐。
- 自动下一集倒计时，可取消并同步。
- 支持全屏、视频音量/语音音量独立调节、视频静音/语音静音。
- 媒体接口支持 HTTP Range 缓冲。

## 6. 媒体处理与存储

### 6.1 格式支持
- 支持上传格式：`.mp4 .webm .ogg .ogv .m4v .mov .mkv .avi .ts`。
- 最终播放能力以浏览器解码能力为准。

### 6.2 统一压缩
- 新上传视频默认统一压缩转码为 `MP4(H.264/AAC)`。
- 支持硬件编码参数与 CPU 回退。

### 6.3 播放池 + OSS
- 所有视频默认存入本地播放池（容量可配置）。
- 播放池满时按 LRU 淘汰，跳过正在播放/读取文件。
- 若配置 OSS：上传后后台传 OSS；本地缺文件时回源到播放池并做 hash 校验。
- 若无可淘汰文件，返回明确错误。

### 6.4 可观测状态
- 上传任务状态需可见：`upload_received -> hashing -> compressing/deduplicating -> storing_local -> uploading_oss(可选) -> completed/failed`。
- 提供播放池使用量、上传限制、磁盘剩余信息展示。

## 7. 管理面
- Root 管理页查看：
  - 全部放映室（可删除）
  - 存储状态（池、磁盘、OSS）
  - 视频处理任务列表与清理

## 8. 兼容迁移
- 旧房间允许保留 `creator_name/creator_token` 字段用于兼容。
- 新逻辑只使用 `created_by_user_id` 做权限判断。
- 对没有 `created_by_user_id` 的 legacy 房间，仅 Root 可删除。
